---
title: '文件管理'
date: 2020-05-03 10:46:22
tags: [Operating System]
published: true
hideInList: false
feature: /post-images/wen-jian-guan-li.jpg
isTop: false
---
[TOC]

# 文件系统基础

## 文件结构

* 无结构文件（流式文件）
* 有结构文件（记录式文件）
    * 顺序文件
        * 顺序存储
            * 可变长记录：无法实现随机存取
            * 定长记录
                * 可实现随机存取。记录长度为L，则第i个记录存放的相对位置为i*L
                * 串结构：记录之间的顺序与关键字无关，无法快速找到某个记录
                * 顺序结构：记录之间的顺序按关键字顺序排列，可以快速找到某个关键字对应的记录
        * 链式存储
            * 无论是定长/可变长记录，都无法实现随机存取，只能从第一个记录依次查找
    * 索引文件
        * 建立一张索引表，每个记录对应一个表项。各记录不用保持顺序，方便增加删除记录
        * 索引表本身就是定长记录的顺序文件，一个索引表项就是一条定长记录，因此索引文件支持随机存取
        * 若索引表按关键字顺序排列，则可支持快速检索
        * 解决了顺序文件不方便增删记录的问题，同时让不定长记录文件实现了随机存取，但索引表可能占用很多空间
    * 索引顺序文件
        * 将记录分组，每组对应一个索引表项
        * 检索记录时先顺序查索引表，找到分组，再顺序查找分组
        * 当记录过多时，可建立多级索引表
    * 直接文件或散列文件

## 文件目录

* 文件控制块FCB
    * 一个文件对应一个FCB，一个FCB就是一个目录项，多个FCB组成文件目录
    * 对目录的操作：搜索，创建文件、删除文件、显示文件、修改文件
* 目录结构
    * 单级目录结构：一个系统只有一张目录表，不允许文件重名
    * 两级目录结构：不同用户可以重名，但不能对文件分类
    * 多级（树形）目录结构
        * 不同目录下的文件可以重名，可以对文件分类，不方便文件共享
        * 系统根据“文件路径”找到目标文件
        * 从根目录出发的路径是绝对路径
        * 从当前目录出发的路径是相对路径
    * 无环图目录结构
        * 在树形目录结构的基础上，增加一些指向同一节点的有向边，使整个目录形成一个有向无环图
        * 为共享节点设置一个共享计数器，计数器为0时才真正删除该节点
* 索引节点
    * 除了文件名之外的所有信息都放到索引节点中，每个文件对应一个索引节点
    * 目录项中只包含文件名、索引节点指针，因此每个目录项的长度大幅减小
    * 由于目录项长度减小，因此每个磁盘块可以存放更多个目录项，因此检索文件时的磁盘I/O操作就少了很多

## 文件物理结构

* 连续分配
* 链接分配：采用离散分配方式，可以为文件分配离散的磁盘块
    * 隐式分配：除文件的最后一个盘块外，每个盘快都存着指向下一个盘块的指针。文件目录包括文件第一块的指针和最后一块的指针
        * 优点：很方便文件扩展，不会有碎片问题，外存利用率高
        * 缺点：只支持顺序访问，不支持随机访问，查找效率第，指针也需要消耗少量的存储空间
    * 显式分配：把用于链接文件的各个物理块的指针显式的存放到一张表中，即文件分配表（FAT），一个磁盘只会简历一张文件分配表，开机时文件分配表放入内存，并常驻内存
        * 优点：很方便文件扩展，不会有碎片问题，外存利用率高，并且支持随机访问。相比于隐式链接来说，地址转换时不需要访问磁盘，因此文件访问效率更高
        * 缺点：文件分配表需要占用一定的存储空间
* 索引分配：允许文件离散的分配在各个磁盘块中，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块，索引表存放的磁盘块称为索引块。文件数据存放的磁盘块称为数据块。如果文件太大，索引表项太多，可以采取以三种方式
    * 链接方式：如果索引表太大，一个索引块装不下，那么可以将多个索引块链接起来存放
        * 缺点：如文件很大，索引表很长，就需要将很多个索引块链接起来，必须从0号索引块开始查找，这样查找效率低
    * 多层索引：建立多层索引表，类似于多级页表，是第一层的索引块指向第二层的索引块，还可以根据文件大小要求建立第三层、第四层索引块，采取K层索引结构，且顶级索引表未调入内存，则访问一个数据块只需要K+1次读磁盘操作
        * 缺点：即使是小文件，访问一个数据块依然需要K+1次读磁盘
    * 混合索引：多种索引分配方式的结合，例如，一个文件的顶级索引表中，既包含直接地址索引（直接指向数据块），又包含一级间接索引（指向单层索引表），还包含两级间接索引（指向两层索引表）
        * 优点：对于小文件来说访问一个数据块所需要的读磁盘次数更少
    * 考点：
        * 1、要回根据多层索引、混合索引的结构计算出文件的最大长度
        * 2、要能自己分析访问讴歌数据块所需要的读磁盘次数

## 文件存储空间管理

* 存储空间的划分与初始化
    * 文件卷（逻辑卷）概念
    * 目录区与文件区
        * 目录区包含文件目录、空闲表，位示图、超级块等数据
* 几种管理方法
    * 空闲表法
        * 空闲表中记录每个连续空闲区的起始盘块号、盘块数
        * 分配时可采用首次适应、最佳适应等策略；回收时注意表项的合并问题
    * 空闲链表法
        * 空闲盘块链
            * 以盘块为单位组成一条空闲链
            * 分配时从链头依次取出空闲块，回收时将空闲块插到链尾
        * 空闲盘区链
            * 以盘区为单位组成一条空闲链
            * 分配时可采用首次适应、最佳适应等策略；回收时注意相邻空闲盘区合并的问题
    * 位示图法
        * 一个二进制对应一个盘块。（字号、位号）或（行号、列号）与【盘号一一对应
        * 要能够自己推出盘块号-->（字号、位号）之前的相互转换关系
    * 成组链接法
        * UNIX采用的策略，适合大型文件系统

## 文件基本操作

* 创建文件：调用create系统调用
* 删除文件：调用delete系统调用
* 读文件：调用read系统调用
* 写文件：调用write系统调用
* 打开文件：调用open系统调用
* 关闭文件：调用close系统调用

## 文件共享

* 硬链接
    * 各个用户的目录项指向同一个索引节点
    * 索引节点中需要有链接技术count
    * 某用户想删除文件时，只删除该用户的目录项，且count--
    * 只有count==0时才能真正删除文件数据和索引节点，否则会导致指针悬空
* 软链接（符号链接）
    * 在一个Link型的文件总记录共享文件的存放路径（windows快捷方式）
    * 操作系统根据路径一层层查找目录，最终找到共享文件
    * 及时软链接指向的共享文件被删除，Link型文件依然存在，只是通过Link型文件中的路径去查找共享文件会失败
    * 由于软链接的方式访问共享文件时要查询多级目录，会有多次磁盘I/O，用软链接访问会比硬链接慢

## 文件保护

* 口令保护
    * 为文件设置一个“口令”，用户想要访问文件时需要提供口令，由系统验证口令是否正确
    * 实现开销小，但“口令“一般存放在FCB或索引节点中，因此不安全
* 加密保护
    * 用一个“密码”对文件加密，用户想要访问文件时，需要提供相同的密码，才能正确的解密
    * 安全性高，但加密/解密需要消耗一定的时间
* 访问控制
    * 用一个访问控制表（ACL）记录各个用户对文件的访问权限
    * 对文件的访问类型可以分为：读/写/执行/删除等
    * 实现灵活，可以实现复杂的文件保护功能

# 文件系统实现

## 文件系统层次结构

## 目录实现

## 文件实现

# 磁盘组织与管理

## 磁盘的结构

* 磁盘、磁道、扇区
    * 磁道由表面涂有磁性物质的圆形盘片组成
    * 每个盘片被划分为一个个磁道，每个磁道又划分为一个个扇区
* 盘面、柱面
    * 磁盘有多个盘片叠加，每个盘片有两个盘面
    * 所有盘面中相对位置相同的磁道组成柱面
* 物理地址：（柱面号，盘面号，扇区号）
* 磁盘分类：
    * 磁头是否可移动
        * 固定头磁盘：每个磁道有一个磁头
        * 移动头磁盘：每个盘面有一个磁头
    * 盘片是否可更换
        * 固定盘磁盘
        * 可换盘磁盘

## 磁盘调度算法

* 一次磁盘读/写操作需要的时间
    * 寻找时间：启动磁臂，移动磁头所花的时间
    * 延迟时间：将目标扇区转到磁头下面所花的时间
    * 传输时间：读写数据花费的时间
* 磁盘调度算法
    * 先来先服务（FCFS）：按访问请求的先后顺序处理
    * 最短寻找时间优先（SSTF）
        * 每次优先响应距离磁头最近的磁道的访问请求
        * 贪心算法思想，可以保证眼前最优，但无法保证寻道时间最短
        * 缺点：可能导致饥饿
    * 扫描算法（SCAN）
        * 只有磁头移动到最边缘的磁道式才可以改变磁头的移动方向
        * 缺点：对各个位置的磁道响应频率不平均
    * 循环扫描算法（C-SCAN）
        * 只有磁头朝某个方向移动时才会响应请求，移动到最边缘后立即让磁头返回起点，返回途中不响应任何请求
    * LOOK算法：SCAN算法的改进，只要磁头移动方向上不再有请求，就立即改变磁头方向
    * C-LOOK算法：C-SCAN算法改进，只要磁头移动方向上不再有请求，就立即让磁头返回

* 减少延迟时间的方法
    * 交替编号
        * 让编号相邻的扇区在物理行不相邻
        * 原理：读完一个扇区后需要一段时间处理才可以继续读入下一个扇区
    * 错位命名：
        * 让相邻盘面的扇区编号“错位”
        * 原理：与交替编号原理相同，错位命名法可以降低延迟时间

## 磁盘的管理

* 磁盘初始化
    * 低级格式化/物理格式化：划分扇区
    * 磁盘分区
    * 逻辑格式化：建立文件系统
* 引导块
    * 计算机启动时需要运行初始化程序（自举程序）来完成初始化
    * ROM中存放很小的自举装入程序
    * 完整的自举程序放在引导块中
* 引导块
* 坏块的管理
    * 简单的磁盘：逻辑格式化时将坏块标记出来
    * 复杂的磁盘：磁盘控制器维护一个坏块链，并管理备用扇区

